<!DOCTYPE html>
<html>

<head>
    <script>
        function print1(){
            if(ente.value!="")
                document.getElementById("p1").innerHTML = "Ente richiedente: "+"<span class='textPrint'>" +ente.value+"</span>";
            else document.getElementById("p1").innerHTML = "Ente richiedente: <span class='errorPrint'>SI PREGA DI COMPILARE IL CAMPO</span>";
        }
        function print2(){
            if(indirizzo.value!=0)
                document.getElementById("p2").innerHTML = "Indirizzo: "+"<span class='textPrint'>" +indirizzo.value+"</span>";
            else document.getElementById("p2").innerHTML = "Indirizzo: <span class='errorPrint'>SI PREGA DI COMPILARE IL CAMPO</span>";
        }
        function print3(){
            if(numsacca.value!=0)
                document.getElementById("p3").innerHTML = "Numero seriale sacca: "+"<span class='textPrint'>" +numsacca.value+"</span>";
            else document.getElementById("p3").innerHTML = "Numero seriale sacca: <span class='errorPrint'>SI PREGA DI COMPILARE IL CAMPO</span>";
        }
        
        
	</script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>EvasioneSaccaForm</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">

    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/formStyles.css">
</head>

<body style="background-color: #ffffff;" onload="start();">
    
    <div class="titlePage">
        <div>
            <span class="fontTitle">
                Evasione Sacca Form            
            </span>
        </div>
        <div>
            <img class="logoCTT" src="assets/img/LOGO_CTT.svg">
        </div>
    </div>
    
    <div class="container" style="max-width: 1430px; margin: 1.5% auto;">
        
        <div class="dateForm">
            <div class="titleDateForm">
                <p>Dati Sacca</p>
                <button class="btn" onclick="location.href='MagazziniereCTT.html';"><img class="return" src="assets/img/return.png" /></button>
            </div>
            <div class="containerForm">
                <form id="myForm">
                    <div class="form-group row">
                            <label style="margin: 5% 5%;">Ente richiedente:</label>
                            <div class="inputForm">
                                <input id="ente" name="ent" oninput="print1();" class="form-control" type="text" style="width: 300px; margin: -1.5em 10%;">
                            </div>
                    </div>
                    <div class="form-group row">
                            <label style="margin: 0% 5%;">Indirizzo:</label>
                            <div class="inputForm">
                                <input id="indirizzo" name="ind" oninput="print2();" class="form-control" type="text" style="width: 300px; margin: 0.1em 10%;">
                            </div>
                    </div>
                    <div class="form-group row" style="margin: 6% 0%">
                            <label style="margin: 0% 5%;">Numero seriale sacca:</label>
                            <div class="inputForm">
                                <select id="numsacca" name="numsacca" oninput="print3()" class="form-control" onfocus='this.size=5;' onblur='this.size=1;' onchange='this.size=1; this.blur();' style="width: 300px; margin: 3% 10%;">
                                        <option value='0'>Seleziona la sacca da evadere</option>
                                </select>
                            </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="previewForm">
            <div class="titleDateForm">
                <p>Anteprima</p>
            </div>
            <div class="outPreview">
                <p id="p1"></p>
                <p id="p2"></p>
                <p id="p3"></p>
            </div>
            <div class="outPreview" style="height: 40px;margin: 4% 45px;">
                <p id="result"></p>
            </div>
            <button class="btn btn-primary" type="submit" onclick="loadDoc()" style="margin-left: 73.5%; width: 140px;height: 51px;font-family: Calibri light;font-size: 20px;">Conferma</button>
            <button id="btnPDF" class="btn btn-warning" type="submit" onclick="creaPdf();" style="visibility: hidden; color: white; margin-left: 6.5%; margin-top: -4em; width: 140px;height: 51px;font-family: Calibri light;font-size: 20px;">PDF</button>
        </div>
        
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
    <script type="application/javascript">
        
            var res;
            var obj;
            var xhttp = new XMLHttpRequest();
            var token = sessionStorage.getItem("token");
            var ruolo = sessionStorage.getItem("ruolo");

            function start(){
                verificoToken();
                keepSacche();
            }




            verificoToken = function(){
               if(token == null || ruolo != 'MagazziniereCTT'){
                alert("E' necessario effettuare il login per accedere a questa risorsa");
                window.location.href='Login.html';
               }
            }
            
            function loadDoc(){
                            	
                var url = "http://127.0.0.1:8080/rest/magazziniere/evasione/" + numsacca.value;
                var indirizzorichiedente = indirizzo.value;
                var enterichiedente = ente.value;
                var params = 'enterichiedente='+enterichiedente+'&indirizzo='+indirizzorichiedente;
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                	    res = this.response;
                 	    document.getElementById("result").innerHTML = "Evasione Riuscita";
                        setTimeout(visiblePDF,1000);
                 	}else {
                        document.getElementById("result").innerHTML = this.response;
                    }

                };
                
                xhttp.onerror = function(){
                    document.getElementById("result").innerHTML = "Sacca non esistente";
                };


                xhttp.open("PUT", url, true);
                xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhttp.setRequestHeader('Authorization', 'Basic '+token);
                xhttp.withCredentials = true;
                xhttp.send(params);

            }
            
            function keepSacche(){
                           
                xhttp = new XMLHttpRequest(); 	
                url = "http://127.0.0.1:8080/rest/magazziniere/sacche";

                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        obj = JSON.parse(this.responseText);
                        addOption();
                        }  

                };
                
                xhttp.open("GET", url, true);
                xhttp.setRequestHeader('Authorization', 'Basic '+token);
                xhttp.withCredentials = true;
                xhttp.send();
                
            }
                        
            function visiblePDF() {
                document.getElementById("btnPDF").style.visibility = "visible";
            }


            function creaPdf() {
	            var doc = new jsPDF();
	            /*var host = "http://"+ window.location.hostname;*/
	            
	            doc.setFontSize(25);
	            doc.text(20, 20, "Evasione sacca "+numsacca.value);

	            doc.setLineWidth(0.5);
                doc.line(20, 25, 197, 25);

                doc.setFontSize(20);
	            doc.text(20, 40, res);
	            //doc.text(20,45,indirizzo.value);


	            // Save the PDF
	            doc.save(numsacca.value+'.pdf');
	        }
            
                        
            function addOption() {
                
                var x = document.getElementById("numsacca");
                var option;
                for(var i=0; i < obj.length; i++) {
                    option = document.createElement('option');
                    option.appendChild(document.createTextNode(obj[i].seriale));
                    option.value=obj[i].seriale;
                    x.appendChild(option);
                }
            }
            

    </script>
        
        
    <div class="footer"></div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/scriptControl.js"></script>
</body>

</html>